# Введение

В процессе работы могут возникать непредвиденные ситуации, в результате которых кластер может оказаться полностью или частично неработоспособным.

В реальной продуктовой среде используются распределенные кластеры, и для резервного копирования чувствительной информации (persistent volumes) используются либо специально выделенные для этого ноды, либо специализированные облачные решения. Например, S3 - совместимые облачные объектные хранилища.

В нашем случае доступны лишь ресурсы обособленного учебного сервера. Поэтому предполагается, что в случае нарушений в работе кластера вернуться в рабочее состояние можно путем возврата к предыдущему стабильному состоянию системы в целом.

Для этих целей использована утилита резервного копирования **Timeshift**

## Установка Timeshift  

```shell
sudo apt install timeshift
```

## Создание первого снимка 

```shell
sudo timeshift --create
```

## Создание скрипта для резервного копирования

Создать файл скрипта ``/timeshift/backup.sh`` следующего содержания

```shell
#!/bin/bash
sudo timeshift --create --comments "Scheduled backup"
```

## Настройка прав на выполнение скрипта 

```bash
sudo chmod +x /timeshift/backup.sh
```

## Настройка cron для автоматического выполнения скрипта 

```bash
crontab -e
0 4 */4 * * /timeshift/backup.sh
```

В этом примере скрипт будет запускаться от имени *<u>текущего пользователя</u>* через каждые 4 дня в 04:00 и создавать резервные копии системы с помощью Timeshift.

Важно иметь ввиду, что при установке утилиты права доступа для созданной директории `/timeshift` принадлежат по умолчанию пользователю `root`. Поэтому необходимо соответствующим образом откорректировать права доступа. По понятным причинам пользователь, от имени которого выполняется задание `crontab`, должен входить в групп `sudo`.

```bash
sudo chown -R <username>:<user's_group_name> /timeshift
sudo chmod -R 755 /timeshift
```

## Настройка удаления старых снимков

Скрипт резервного копирования создает при каждом запуске новый снимок. Несмотря на то, что резервные снимки создаются в режиме `rsync`, их размер может оказаться достаточно значимым. Поскольку в нашем распоряжении нет значительных объемов дискового пространства для хранения снапшотов, появляется необходимость удалять старые, не актуальные снимки. Для этого нужно соответственно откорректировать скрипт backup.sh.

Ниже приведен пример скрипта, который создает новую резервную копию и удаляет все старые резервные копии, кроме двух самых последних:

- Создает новую резервную копию с комментарием "Scheduled backup";
  
- Фильтрует строки, содержащие слово "Snapshot" из списка ранее созданных снимков;
  
- Извлекает четвертое поле из каждой строки (предполагается, что это идентификатор или имя резервной копии);
  
- Пропускает первые две строки (оставляя только старые резервные копии);
  
- Удаляет все оставшиеся резервные копии, используя их идентификаторы.

```bash
#!/bin/bash
sudo timeshift --create --comments "Scheduled backup"
sudo timeshift --list | grep "Snapshot" | awk '{print $4}' | tail -n +3 | xargs -I {} sudo timeshift --delete --snapshot {}
```

## Восстановление системы из резервной копии с помощью Timeshift

Для восстановления системы из резервной копии с помощью Timeshift, выполните следующие шаги:

1. Получите список доступных снимков системы;

```bash
sudo timeshift --list
```

2. Выбрав нужный снимок, используйте команду для восстановления системы из выбранного снимка. Например, если имя снимка `2024-12-09_04-00-00`, команда будет выглядеть так:

```bash
sudo timeshift --restore --snapshot '2024-12-09_04-00-00'
```

3. Следуйте инструкциям: Timeshift может попросить Вас подтвердить некоторые действия или предоставить дополнительную информацию. Следуйте инструкциям на экране, чтобы завершить процесс восстановления.
